# Import Data {#import_data}

```{r, include=FALSE, warning=F, message=F}
# data mgmt
library(tidyverse)
library(lubridate)
# visualization
library(RColorBrewer)
library(scales)
library(viridis)
library(kableExtra)
# spatial
library(sf)
library(stars)
library(lwgeom) 
library(mapview) #Interactive maps
library(leafpop) #map html popup
library(elevatr) # elevation data (DEMs)
# knit options
knitr::opts_chunk$set(
  echo = TRUE
  , warning = FALSE
  , message = FALSE
  , results='hide'
  , fig.width = 10
  , fig.height = 7
)
# qualitative color pallette
my_color_pal_qual <- function(n) viridis::turbo(n = n * 4)[which(seq(1,n * 4,1) %% 4 == 0)]
```

```{r}
# turn off the s2 processing 
## https://stackoverflow.com/questions/68478179/how-to-resolve-spherical-geometry-failures-when-joining-spatial-data
sf::sf_use_s2(FALSE)

# set crs
my_crs <- 5070 # EPSG:5070 = NAD83/Conus Albers (units = meters); EPSG:4326 = WGS 84 (units = dd); EPSG:4269 = NAD83 (units = dd)
```

## National Forest Management data download

The Forest Activity Tracking System (FACTS) [database](https://data.fs.usda.gov/geodata/edw/datasets.php?xmlKeyword) maintained by the U.S. Department of Agriculture, Forest Service (USFS) includes georeferenced boundaries of national forests.

```{r}
# load boundary shapefile
  forests <- sf::st_read("../data/forests.gpkg") %>%
    rename_with(~ tolower(
      gsub(" ", "_",
         str_trim(gsub("\\s+", " ", .x))
      )
    )) %>% 
    sf::st_transform(my_crs) # EPSG:4326 = WGS 84
# keep GMUG
gmug <- forests %>% 
  dplyr::filter(
    forest_commonname %in% c(
      "Grand Mesa National Forest"
      , "Uncompahgre National Forest"
      , "Gunnison National Forest"
    )
  ) %>% 
  sf::st_union()

```

### GMUG Map

```{r, results='asis'}
mapview::mapviewOptions(homebutton = FALSE, basemaps = c("Esri.WorldTopoMap")) # "Esri.WorldImagery"
mapview::mapview(
  x = gmug
  , color = "black"
  , lwd = 4
  , alpha.regions = 0
  , label = FALSE
  , legend = FALSE
  , popup = FALSE
  , map.types = "Esri.WorldTopoMap" # "Esri.WorldImagery"
)
```


## Load Treatment data

```{r}
############################
# load shapefiles
############################
shp_import_fn <- function(pth){
  # import
  dta <- sf::st_read(pth) %>% 
    dplyr::filter(sf::st_is_valid(.)) %>% 
    rename_with(~ tolower(
      gsub(" ", "_", 
         str_trim(gsub("\\s+", " ", .x))
      )
    )) %>% 
    sf::st_transform(crs = sf::st_crs(forests)) %>% 
    dplyr::mutate(area = sf::st_area(.))
  #rename sf geom column
  names(dta)[names(dta)==tolower(attr(dta, "sf_column"))] = "geometry"
  sf::st_geometry(dta) = "geometry"
  # return
  return(dta)
}

# group selection openings
openings <- shp_import_fn("../data/Bald_all_groups.shp")

# group selection reserve groups
reserves <- shp_import_fn("../data/Bald_all_Reserve_grps.shp")

# harvest units
units <- shp_import_fn("../data/UnitEstimate.shp")
```

### GMUG and treatment area map

```{r}
ggplot() + 
  geom_sf(
    data = gmug
    , alpha = 0
    , lwd = 1, color = "black" 
  ) +
  geom_sf(
    data = units %>% sf::st_union() %>% sf::st_buffer(dist = 500)
    , fill = "royalblue"
    , lwd = NA
  ) +
  labs(
    title = "GMUG boundary and treatment area in blue"
  ) +
  theme_bw() + 
  theme(
    legend.position = "none"
  )
```


### Treatment units and group map

```{r}
ggplot() + 
  geom_sf(
    data = units
    , mapping = aes(fill = unit_numbe)
    , lwd = 0.8, color = "black" 
  ) +
  geom_sf(data = openings, fill = "white", color = "firebrick", lwd = 1) +
  geom_sf(data = reserves, fill = "black", color = "black") +
  scale_fill_viridis_d(option = "turbo", alpha = 0.4) +
  labs(
    title = "Harvest treatment units and groups"
    , subtitle = "Reserves = black, Openings = white"
  ) +
  theme_bw() + 
  theme(
    legend.position = "none"
  )
```


## Load Elevation Data

The function `elevatr::get_elev_raster` was used to obtain a digital elevation model (DEM) raster (~6.8m resolution).

```{r}
#######################################################
#######################################################
# read elevation data
#######################################################
#######################################################
  if(file.exists("../data/gmug_elev.tif") == FALSE){
      # z =14 is highest resolution (~6.8m)
      elev <- elevatr::get_elev_raster(
          locations = units %>% 
            sf::st_union() %>% 
            sf::st_buffer(dist = 100)
          , z = 14
        ) %>% 
        stars::st_as_stars()
      # save
      stars::write_stars(elev, "../data/elev.tif", append = FALSE)
  }else{
    elev <- stars::read_stars("../data/elev.tif")
  }
```

### Elevation plot

```{r, warning=F, message=F, fig.width = 10, fig.height = 6}
# plot
ggplot() + stars::geom_stars(data = elev) +
  scale_fill_viridis_c(option = "viridis", alpha = 0.9, na.value = "transparent") +
  geom_sf(data = units, alpha = 0, lwd = 1, color = "black") +
  labs(
      title = "GMUG Treatment Units Elevation Map"
      , subtitle = sf::st_crs(elev)$input
    ) +
  xlab("") +
  ylab("") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 8)
    # , panel.grid = element_blank()
    , panel.border = element_blank()
  ) +
  guides(
    fill = guide_legend(title="Elev. (m)")
  )

```

```{r, echo=FALSE, include=FALSE}
gc()
```
